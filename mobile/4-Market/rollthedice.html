<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Roll the Dice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #1E1F26;
      color: #fff;
      margin: 0;
      padding: 30px;
      text-align: center;
    }
    h1 {
      color: #FFC107;
      margin-bottom: 20px;
    }
    .dice {
      width: 100px;
      height: 100px;
      background: #2A2B32;
      border: 4px solid #FFC107;
      border-radius: 16px;
      margin: 30px auto;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      justify-items: center;
      align-items: center;
      transition: transform 0.3s ease;
    }
    .dot {
      width: 12px;
      height: 12px;
      background: #fff;
      border-radius: 50%;
      opacity: 0;
    }
    .dot.active {
      opacity: 1;
    }
    .btn {
      background: #FFC107;
      color: #1E1F26;
      font-size: 20px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn:hover {
      background: #e0a800;
    }
    .result {
      margin-top: 20px;
      font-size: 20px;
      color: #FFC107;
      font-weight: bold;
    }
    ul.reward-list {
      margin-top: 40px;
      text-align: left;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
      font-size: 16px;
      line-height: 1.6;
    }
    ul.reward-list li {
      margin-bottom: 6px;
    }
    .error-message {
      color: #FF6666;
      margin-top: 40px;
      font-size: 18px;
    }
    .close-btn {
      display: none;
      margin-top: 30px;
      background: #FFC107;
      color: #1E1F26;
      font-size: 18px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    .close-btn:hover {
      background: #e0a800;
    }
  </style>
</head>
<body>

  <h1>üé≤ Roll the Dice</h1>

  <div class="dice" id="dice">
    <div class="dot" id="d1"></div>
    <div class="dot" id="d2"></div>
    <div class="dot" id="d3"></div>
    <div class="dot" id="d4"></div>
    <div class="dot" id="d5"></div>
    <div class="dot" id="d6"></div>
    <div class="dot" id="d7"></div>
    <div class="dot" id="d8"></div>
    <div class="dot" id="d9"></div>
  </div>

  <button class="btn" onclick="rollDice()">Roll</button>
  <div class="result" id="resultText"></div>
  <button class="close-btn" id="closeBtn" onclick="goBack()">Close</button>

  <ul class="reward-list" id="rewardLegend"></ul>

  <script>
    let user = "";
    let outcomes = [];

    const dotMap = {
      1: [5],
      2: [1, 9],
      3: [1, 5, 9],
      4: [1, 3, 7, 9],
      5: [1, 3, 5, 7, 9],
      6: [1, 3, 4, 6, 7, 9]
    };

    const dots = Array.from({ length: 9 }, (_, i) => document.getElementById("d" + (i + 1)));
    const resultText = document.getElementById("resultText");
    const rewardLegend = document.getElementById("rewardLegend");
    const closeBtn = document.getElementById("closeBtn");

    function showFace(n) {
      dots.forEach(dot => dot.classList.remove("active"));
      dotMap[n].forEach(index => {
        document.getElementById("d" + index).classList.add("active");
      });
    }

    function formatOutcomeText(outcome) {
  if (typeof outcome === "string") return outcome;
  if (outcome?.type === "Honey (amount)" || outcome?.type === "honey") {
    return `${outcome.value || outcome.amount} Honey üçØ`;
  }
  return outcome?.type || "Mystery Reward";
}


    function rollDice() {
      resultText.textContent = "";
      closeBtn.style.display = "none";
      let currentRoll = 0;
      let rollTimes = 30;
      let delay = 40;

      function animateRoll() {
        const number = Math.floor(Math.random() * 6) + 1;
        showFace(number);
        currentRoll++;
        if (currentRoll < rollTimes) {
          delay += 12;
          setTimeout(animateRoll, delay);
        } else {
          setTimeout(() => {
            const result = number;
            const reward = outcomes[result - 1];
            const outcomeText = formatOutcomeText(reward);
            resultText.textContent = `You got: ${outcomeText}`;
            grantChestToUser(user, reward);
            removeDiceChestFromUser(user);
            closeBtn.style.display = "inline-block";
          }, 300);
        }
      }

      animateRoll();
    }












    function grantChestToUser(userName, reward) {
  const allChests = JSON.parse(localStorage.getItem("familyApp_luckyChests")) || {};
  if (!allChests[userName]) allChests[userName] = [];

  const allChestsList = JSON.parse(localStorage.getItem("customChests")) || [
    { name: "The Key", quote: "You hold the key to the path of others.", effect: "‚û° Transfer one of your tasks to another user. You get the honey.", image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/Keyy.gif" },
    { name: "Double Trouble", quote: "Today‚Äôs efforts are worth double.", effect: "‚û° Next task = double honey.", image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/DoubleTrouble.png" },
    { name: "Roll the Dice", quote: "Test your Luck", effect: "‚û° Get a surprise reward.", image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/dice.gif" },
    { name: "Dance Party", quote: "Feel the rhythm!", effect: "‚û° Dance after a task. If someone joins, both get honey.", image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/Dance.jpg" },
    { name: "Bee-Witched!", quote: "Your magical aura changes the rules...", effect: "‚û° Make a silly rule. Others who follow it get honey.", image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/Bee-Witched.jpg" },
    { name: "Special Buzz Off", quote: "You‚Äôre too cool for chores today.", effect: "‚û° Skip all tasks today.", image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/Special.jpg" }
  ];

  let chest;

  if (reward.type === "Honey (amount)" || reward.type === "honey") {
    const honeyAmount = parseInt(reward.value || reward.amount);

    // üü° Create a chest that holds Honey ‚Äî don't reward yet!
    chest = {
      name: `${honeyAmount} Honey`,
      quote: "",
      effect: `üçØ Collect ${honeyAmount} honey instantly!`,
      image: "/BeeMazing-Y1/mobile/4-Market/LuckyChest/honey.gif",
      honey: honeyAmount,
      requiredPoints: 0,
      progress: 0,
      type: "normal",
      fromDiceChest: true
    };

  } else {
    const match = allChestsList.find(c => c.name === reward.type);
    chest = {
      name: match?.name || reward.type || "Mystery Reward",
      quote: match?.quote || "",
      effect: match?.effect || "",
      image: match?.image || "/BeeMazing-Y1/mobile/4-Market/LuckyChest/default.png",
      requiredPoints: 0,
      progress: 0,
      type: "normal",
      fromDiceChest: true
    };
  }

  allChests[userName].push(chest);
  localStorage.setItem("familyApp_luckyChests", JSON.stringify(allChests));
}












    function removeDiceChestFromUser(userName) {
      const rewards = JSON.parse(localStorage.getItem("familyApp_user_rewards")) || {};
      const history = JSON.parse(localStorage.getItem("familyApp_reward_history")) || {};
      if (!rewards[userName]) return;

      const index = rewards[userName].findIndex(r => r.type === "dice");
      if (index !== -1) {
        const reward = rewards[userName][index];
        rewards[userName].splice(index, 1);

        if (!history[userName]) history[userName] = [];
        history[userName].push({
          name: reward.name,
          date: reward.date,
          receivedDate: new Date().toLocaleDateString()
        });

        localStorage.setItem("familyApp_user_rewards", JSON.stringify(rewards));
        localStorage.setItem("familyApp_reward_history", JSON.stringify(history));
      }
    }

    function goBack() {
      window.location.href = `/BeeMazing-Y1/mobile/2-UserProfiles/users.html?user=${encodeURIComponent(user)}`;
    }

    document.addEventListener("DOMContentLoaded", function () {
      const params = new URLSearchParams(window.location.search);
      user = params.get("user");
      const encodedData = params.get("data");

      try {
        const decoded = JSON.parse(atob(decodeURIComponent(encodedData)));
        if (!decoded || decoded.type !== "dice" || !Array.isArray(decoded.outcomes) || decoded.outcomes.length !== 6) {
          throw new Error("Invalid dice object");
        }
        outcomes = decoded.outcomes;

        rewardLegend.innerHTML = "";
        outcomes.forEach((outcome, i) => {
          const li = document.createElement("li");
          li.textContent = `${i + 1} = ${formatOutcomeText(outcome)}`;
          rewardLegend.appendChild(li);
        });

      } catch (e) {
        document.body.innerHTML = `<p class="error-message">Invalid Dice Chest format.</p>`;
      }
    });
  </script>
</body>
</html>
